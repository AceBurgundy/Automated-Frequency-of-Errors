<!DOCTYPE html>
<html>
  <head>
    <title>My Excel-like Website</title>
    <link rel="stylesheet" href="GetStarted.css" />
  </head>
  <body>

    <div id="content-container"></div>
    <div id="buttons-container">
      <button id="add-new-row">Add row</button>
      <button id="save-as-csv">Save As CSV</button>
      <div id="frequency-input-container">
        <input type="number" id="frequency-input">
        <button id="frequency-setter">Set Frequency</button>
      </div>
    </div>
    
    <script>

      let frequency = 0.0;
      let startedAddingData = false;

      // Add event listener to the "Add row" button
      document.addEventListener("DOMContentLoaded", function () {

        function saveTableAsCSV() {
            const table = document.getElementById("content-table");
            const rows = table.getElementsByTagName("tr");

            let csvContent = "";

            // Add table name to CSV
            const tableName = document.getElementById("table-name").textContent.trim();
            csvContent += `${tableName}\n`;

            // Add header names to CSV
            const headerRow = rows[0];
            const headerCells = headerRow.getElementsByTagName("th");

            for (let j = 0; j < headerCells.length; j++) {
                const headerCell = headerCells[j].textContent.trim();

                if (headerCell.includes(",")) {
                csvContent += `"${headerCell}"`;
                } else {
                csvContent += headerCell;
                }

                if (j < headerCells.length - 1) {
                csvContent += ",";
                }
            }

            csvContent += "\n";

            // Add table data to CSV
            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName("td");

                for (let j = 0; j < cells.length; j++) {
                const cell = cells[j];

                let cellValue = "";

                // Check if the cell has an input element
                const inputElement = cell.querySelector("input");
                if (inputElement) {
                    cellValue = inputElement.value.trim();
                } else {
                    cellValue = cell.textContent.trim();
                }

                if (cellValue.includes(",")) {
                    cellValue = `"${cellValue}"`;
                }

                csvContent += cellValue;

                if (j < cells.length - 1) {
                    csvContent += ",";
                }
                }

                csvContent += "\n";
            }

            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });

            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "table.csv");
            link.click();
            }

        const saveAsCSVButton = document.getElementById("save-as-csv");
        saveAsCSVButton.addEventListener("click", saveTableAsCSV);
        
        function TableHeader(columns) {
          return `
                <thead>
                <tr>
                    ${columns.map((column) => `<th>${column}</th>`).join("")}
                </tr>
                </thead>
            `
        }

        function TableRow(data) {
          return `
                <tr>
                ${data.map(cell => cell).join("")}
                </tr>
            `
        }

        function TableBody(rows) {
          return `
                <tbody id="table-body">
                ${rows.map((row) => TableRow(row)).join("")}
                </tbody>
            `
        }

        function Table({ title, rows, columns }) {
            return `
                <div id="content-container">
                <h1 id="table-name">${title}</h1>
                <table id="content-table">
                    ${TableHeader(columns)}
                    ${TableBody(rows)}
                </table>
                </div>
            `
        }

        function createTable(numRows) {
          const table1Title = "FREQUENCY OF WRONG"
          const table1Rows = []
          const table1Columns = [
            "NO.",
            "Item #",
            "FCR",
            "%",
            "Item #",
            "FCR",
            "%",
            "Item #",
            "FCR",
            "%",
            "Item #",
            "FCR",
            "%",
            "Item #",
            "FCR",
            "%",
          ]

          for (let i = 1; i <= numRows; i++) {
            const row = []
            row.push(`<td>${i}.</td>`)
            row.push(`<td>${i}</td>`)

            if (i <= numRows) {
              row.push(`<td class="data-container"></td>`)
              row.push(`<td class="data-receiver"></td>`)
            }

            let increment = 0

            for (let j = 1; j <= 5; j++) {
              increment = i + 10

              if (j <= 4) {
                row.push(`<td>${increment + j * 10}</td>`)
                row.push(`<td class="data-container"></td>`)
                row.push(`<td class="data-receiver"></td>`)
              }
            }
            table1Rows.push(row)
          }

          const table1 = Table({
            title: table1Title,
            rows: table1Rows,
            columns: table1Columns,
          })

          document.getElementById("content-container").innerHTML = table1
        }

        createTable(10)

        function createTableRowFromLastRow(lastRow) {
            const lastRowCells = [...lastRow.children];

            let newLastRowCells = lastRowCells.map((cell, index) => {
                if (index === 0) {
                return `<td>${parseInt(cell.textContent) + 1}.</td>`;
                }

                if (cell.className === "data-container" || cell.className === "data-receiver") {
                return cell.outerHTML;
                }

                const inputElement = cell.querySelector("input");
                if (inputElement) {
                return `<td>${inputElement.value}</td>`;
                }

                return `<td>${parseInt(cell.textContent) + 1}</td>`;
            }).join("");

            return newLastRowCells;
        }


        function incrementCellValue(cell) {
            if (cell.textContent !== "") {
                cell.textContent = parseInt(cell.textContent) + 1
            }
        }

        function handleContainerClick(event) {
            
            if (frequency === 0.0) {
                alert("frequency cannot be 0");
                return;
            }

            event.target.innerHTML = `
                <input class="data-container-input" type="number"/>
            `;

            startedAddingData = true;

            const input = event.target.querySelector(".data-container-input");

            input.addEventListener("input", (e) => {
                if (isNaN(e.target.value)) {
                    alert("Numbers Only");
                    e.target.value = "";
                    return;
                }

                const changedValue = parseInt(e.target.value);
                let solving = (changedValue / frequency) * 100; // Modified calculation
                const siblingElement = container.nextElementSibling;
                if (siblingElement) {
                    if (!isNaN(solving)) {
                        siblingElement.textContent = solving.toFixed(2);
                    } else {
                        siblingElement.textContent = "";
                    }
                }
            });
        }
        
        function addNewRow() {
            const tableBody = document.getElementById("table-body");
            const lastRow = tableBody.lastElementChild;

            const newRowCells = createTableRowFromLastRow(lastRow);
            const newRowParent = document.createElement("tr");
            newRowParent.innerHTML = newRowCells;
            tableBody.appendChild(newRowParent);

            // Add event listeners to the new row
            newRowParent.querySelectorAll(".data-container").forEach(container => {
                container.addEventListener("click", handleContainerClick);
            });
        }

        const addRowButton = document.getElementById("add-new-row")
        addRowButton.addEventListener("click", addNewRow)

        document.querySelectorAll(".data-container").forEach(container => {
            container.addEventListener("click", handleContainerClick)
        })

        document.getElementById("frequency-setter").addEventListener("click", () => {

            const newFrequencyValue = document.getElementById("frequency-input").value

            if (newFrequencyValue === 0) {
                alert("Frequency cannot be 0")
                return
            }

            if (isNaN(newFrequencyValue)) {
                alert("Frequency should be a number")
                return
            }

            if (startedAddingData) {
                result = confirm(`Click yes to update all data to use the new frequency ${newFrequencyValue}`)
            
                if (result) {

                    frequency = parseInt(newFrequencyValue * 1.0)

                    const inputContainer = document.querySelectorAll(".data-container")

                    inputContainer.forEach(container => {

                        if (container.firstElementChild !== null) {
                            const containerValue = parseInt(container.firstElementChild.value)
                            let solving = (containerValue / newFrequencyValue) * 100
                            
                            const siblingElement = container.nextElementSibling
                            if (siblingElement) {
                                siblingElement.textContent = solving.toFixed(2)
                            }
                        }
                    })
                } 
            } else {
                if (newFrequencyValue === "") {
                    alert("Please insert frequency first")
                    return
                } else {
                    console.log(newFrequencyValue);
                    frequency = parseInt(newFrequencyValue * 1.0)
                    alert(`New Frequency is ${newFrequencyValue}`)
                }
            }   
        })
        
    })

    </script>
  </body>
</html>
